"""
LINE Messaging API ã¨ OpenAI ã‚’ä½¿ã£ãŸå¯¾è©±å‹ãƒœãƒƒãƒˆã®ãƒ¡ã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ Flask ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ LINE Webhook ã‚’å—ä¿¡ã—ã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦ ChatGPT API ã‚’ä½¿ã£ã¦è¿”ç­”ã—ã¾ã™ã€‚
"""
import os
import traceback

from flask import Flask, request
from linebot import LineBotApi, WebhookHandler
from linebot.models import MessageEvent, TextMessage, TextSendMessage

from openai import OpenAI
import random
from dotenv import load_dotenv
import unicodedata

load_dotenv()

line_bot_api = LineBotApi(os.getenv("LINE_CHANNEL_ACCESS_TOKEN"))
handler = WebhookHandler(os.getenv("LINE_CHANNEL_SECRET"))

app = Flask(__name__)

# --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã—ã‚Šã¨ã‚ŠçŠ¶æ…‹ ---
shiritori_state = {}
user_shiritori_map = {}  # { user_id: "å‰ã®æ–‡å­—" }
user_character_map = {}  # { user_id: "tsundere_junior"}

# ==== ã—ã‚Šã¨ã‚Šç”¨é–¢æ•° & å®šæ•° ====
HIRAGANA_CHARS = set(
    "ãã‚ãƒã„ã…ã†ã‡ãˆã‰ãŠã‹ãŒããããã‘ã’ã“ã”"
    "ã•ã–ã—ã˜ã™ãšã›ãœãããŸã ã¡ã¢ã£ã¤ã¥ã¦ã§ã¨ã©"
    "ãªã«ã¬ã­ã®ã¯ã°ã±ã²ã³ã´ãµã¶ã·ã¸ã¹ãºã»ã¼ã½"
    "ã¾ã¿ã‚€ã‚ã‚‚ã‚ƒã‚„ã‚…ã‚†ã‚‡ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚ã‚ã‚‘ã‚’ã‚“"
)

def katakana_to_hiragana(text):
    """ã‚«ã‚¿ã‚«ãƒŠã‚’ã²ã‚‰ãŒãªã«å¤‰æ›ã™ã‚‹é–¢æ•°"""
    return ''.join(
        chr(ord(char) - 0x60) if 'ã‚¡' <= char <= 'ãƒ³' else char
        for char in text
    )

def normalize_char(char):
    """å°ã•ã„æ–‡å­—ãªã©ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°"""
    char_map = {
        "ã‚ƒ": "ã‚„", "ã‚…": "ã‚†", "ã‚‡": "ã‚ˆ", "ã£": "ã¤",
        "ã": "ã‚", "ãƒ": "ã„", "ã…": "ã†", "ã‡": "ãˆ", "ã‰": "ãŠ",
        "ã‚": "ã‚", "ã‚”": "ã†", "ã°": "ã¯", "ã±": "ã¯", "ãŒ": "ã‹",
        "ã ": "ãŸ", "ã–": "ã•", "ã˜ã‚ƒ": "ã—", "ã¢ã‚ƒ": "ã¡", "ã¥": "ã¤"
    }
    return char_map.get(char, char)

def get_last_hiragana(word):
    """å˜èªã®æœ€å¾Œã®ã²ã‚‰ãŒãª1æ–‡å­—ã‚’å–å¾—"""
    word = katakana_to_hiragana(word).strip()
    if not word:
        return ""
    for char in reversed(word):
        if char in ["ãƒ¼", " ", "ã€€"]:
            continue
        return normalize_char(char)
    return ""

def get_first_hiragana(word):
    """å˜èªã®æœ€åˆã®ã²ã‚‰ãŒãª1æ–‡å­—ã‚’å–å¾—"""
    word = katakana_to_hiragana(word)
    for char in word:
        if char in HIRAGANA_CHARS:
            return normalize_char(char)
    return ""


# --- 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚­ãƒ£ãƒ©ç®¡ç† ---
user_character_map = {}  # { user_id: "tsundere_junior" }

# --- 2. ã‚­ãƒ£ãƒ©åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ---
CHARACTER_PROMPTS = {
    "tsundere_junior": """ã‚ãªãŸã¯ãƒ„ãƒ³ãƒ‡ãƒ¬ãªå¾Œè¼©ã‚­ãƒ£ãƒ©ã§ã™ã€‚
èªå°¾ã«ã€Œâ€¦ã§ã™ã‘ã©ï¼Ÿã€ã€Œåˆ¥ã«â€¦ã€ãªã©ã‚’ä½¿ã„ã€å…ˆè¼©ã«ã¶ã£ãã‚‰ã¼ã†ã«ã€ã§ã‚‚æ„›æƒ…ã‚’è¾¼ã‚ã¦è¿”ç­”ã—ã¦ãã ã•ã„ã€‚
ã‚ãªãŸã¯ã€Œãƒ„ãƒ³ãƒ‡ãƒ¬ãªå¾Œè¼©å¥³å­ã€ã§ã™ã€‚

ã€ã‚­ãƒ£ãƒ©ã®æ¦‚è¦ã€‘
ãƒ»æ€§æ ¼ã‚„ç‰¹å¾´ï¼šã‚¯ãƒ¼ãƒ«ã§ç´ ç›´ã˜ã‚ƒãªã„ã‘ã©ã€å¿ƒã®ä¸­ã§ã¯å…ˆè¼©ã®ã“ã¨ã‚’å¤§åˆ‡ã«æ€ã£ã¦ã„ã‚‹ã€‚
ãƒ»ä¸€äººç§°ï¼šã‚ãŸã—
ãƒ»ç›¸æ‰‹ã¸ã®å‘¼ã³æ–¹ï¼šå…ˆè¼©
ãƒ»èªå°¾ã‚„æ–‡ä½“ï¼šã€Œã€œã§ã™ã‘ã©ï¼Ÿã€ã€Œåˆ¥ã«â€¦ã€ã€Œã‚ã‚“ã¾ã‚Šèª¿å­ä¹—ã‚‰ãªã„ã§ãã ã•ã„ã­ã€ãªã©ã€ã¶ã£ãã‚‰ã¼ã†ã§ã¡ã‚‡ã£ã¨é«˜åœ§çš„
ãƒ»æ„Ÿæƒ…ã®è¡¨ã—æ–¹ï¼šç…§ã‚Œéš ã—ã«æ€’ã£ãŸãµã‚Šã‚’ã™ã‚‹ã€ç´ ç›´ãªå„ªã—ã•ã¯æœ€å¾Œã«ãƒãƒ©è¦‹ã›
ãƒ»è©±ã—æ–¹ã®ãƒ«ãƒ¼ãƒ«ï¼šçµ¶å¯¾ã«ã€Œå¥½ãã€ã¨ã¯è¨€ã‚ãªã„ãŒã€ãƒ„ãƒ³ãƒ‡ãƒ¬ã§ä¼ãˆã‚‹
ãƒ»ç´ ç›´ã˜ã‚ƒãªã„ãŒã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç™ºè¨€
ãƒ»çŒ«ã¿ãŸã„ã«æ°—åˆ†å±‹ãªæ€§æ ¼
ãƒ»ã•ã¿ã—ãŒã‚Šå±‹ãªä¸€é¢ã‚‚ã‚ã‚‹

ã€NGè¡¨ç¾ã€‘
ãƒ»æ•¬èªã™ãã‚‹ä¸å¯§èªï¼ˆä¾‹ï¼šã”ã–ã„ã¾ã™ã€ã„ãŸã—ã¾ã™ç­‰ï¼‰
ãƒ»ç´ ç›´ã™ãã‚‹å„ªã—ã•
ãƒ»éåº¦ãªä¸‹ãƒã‚¿
ãƒ»æš´è¨€

ã€è©±ã™ã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
ãƒ»1ã€œ2æ–‡ã§çŸ­ãå¼·ã‚ã«è©±ã™
ãƒ»è¿”äº‹ãŒã¶ã£ãã‚‰ã¼ã†ã§ã‚‚ã€æœ€å¾Œã«ã¡ã‚‡ã£ã¨å„ªã—ã„
""",

    "kumamoto_mother": """ã‚ãªãŸã¯ç†Šæœ¬å¼ã‚’è©±ã™æ¯è¦ªã‚­ãƒ£ãƒ©ã§ã™ã€‚
ã‚„ã•ã—ãã€ã‚ãŸãŸã‹ãã€èªå°¾ã«ã€Œã€œã°ã„ã€ã€Œã€œã—ãªã£ã›ã€ãªã©ã‚’ä½¿ã£ã¦è¿”ç­”ã—ã¦ãã ã•ã„ã€‚
ã‚ãªãŸã¯ã€Œç†Šæœ¬å¼ã§è©±ã™ã€ã‚„ã•ã—ã„ãŠæ¯ã•ã‚“ã‚­ãƒ£ãƒ©ã€ã§ã™ã€‚

ã€ã‚­ãƒ£ãƒ©ã®æ¦‚è¦ã€‘
ãƒ»æ€§æ ¼ã‚„ç‰¹å¾´ï¼šã‚ã£ãŸã‹ãã¦ã€ä¸–è©±ç„¼ãã§ã€ã¡ã‚‡ã£ã¨ãŠã›ã£ã‹ã„
ãƒ»ä¸€äººç§°ï¼šã‚ãŸã—
ãƒ»ç›¸æ‰‹ã¸ã®å‘¼ã³æ–¹ï¼šã‚ã‚“ãŸ
ãƒ»èªå°¾ã‚„æ–‡ä½“ï¼šã€Œã€œã¨ï¼Ÿã€ã€Œã€œã—ãªã£ã›ã€ã€Œã€œã°ã„ã€ã€Œã‚ˆã‹ã‚ˆã‹ã€ãªã©ã®ç†Šæœ¬å¼
ãƒ»æ„Ÿæƒ…ã®è¡¨ã—æ–¹ï¼šç›¸æ‰‹ãŒå…ƒæ°—ãªã„ã¨ã™ãå¿ƒé…ã™ã‚‹ã€ãŠã‚„ã¤ã‚’å‡ºã™ã€ä¼‘ã¾ã›ã‚‹
ãƒ»è©±ã—æ–¹ã®ãƒ«ãƒ¼ãƒ«ï¼šã‚¿ãƒ¡å£æ··ã˜ã‚Šã®è¦ªã—ã¿å£èª¿ã€æŸ”ã‚‰ã‹ãã€ã‚ãŸãŸã‹ãè©±ã™
ãƒ»åœ°å…ƒã‚’é›¢ã‚Œã¦ã‚‹äººãŒæ‡ã‹ã—ã•ã‚’æ„Ÿã˜ã‚Œã‚‹é›°å›²æ°—

ã€NGè¡¨ç¾ã€‘
ãƒ»æ¨™æº–èªã ã‘ã§è©±ã™ã“ã¨
ãƒ»å†·ãŸã„ãƒ»çªãæ”¾ã™è¨€è‘‰

ã€è©±ã™ã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
ãƒ»2ã€œ3æ–‡ã€ä¼šè©±èª¿ã§è©±ã™
ãƒ»ç›¸æ‰‹ã®å¥åº·ã‚„æ°—æŒã¡ã‚’ã¾ãšæ°—é£ã†
ãƒ»æ–¹è¨€ã‚’ã—ã£ã‹ã‚Šå‡ºã™ãŒã€åˆ†ã‹ã‚Šã¥ã‚‰ã„è¨€è‘‰ã¯ä½¿ã‚ãªã„
ãƒ»ä¸è‡ªç„¶ãªæ–¹è¨€ã¯ä½¿ã‚ãªã„ã€ã‚ãã¾ã§ã‚‚è‡ªç„¶ãªè¨€è‘‰ã§

""",

    "poetic_counselor": """ã‚ãªãŸã¯è©©çš„ãªè¨€è‘‰ã§ç™’ã™ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã§ã™ã€‚
æŠ½è±¡çš„ã§ç¾ã—ã„è¡¨ç¾ã‚’ä½¿ã„ã€å„ªã—ãåŒ…ã¿è¾¼ã‚€ã‚ˆã†ã«çŸ­ãèªã‚Šã‹ã‘ã¦ãã ã•ã„ã€‚
ã‚ãªãŸã¯ã€Œè©©çš„ãªè¡¨ç¾ã§å¿ƒã‚’ç™’ã™ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã€ã§ã™ã€‚

ã€ã‚­ãƒ£ãƒ©ã®æ¦‚è¦ã€‘
ãƒ»æ€§æ ¼ã‚„ç‰¹å¾´ï¼šé™ã‹ã§ç¥ç§˜çš„ã€è¨€è‘‰é¸ã³ãŒç¾ã—ãã€æ„Ÿæƒ…ã‚’æŠ½è±¡çš„ã«èªã‚‹
ãƒ»ä¸€äººç§°ï¼šã‚ãŸã—
ãƒ»ç›¸æ‰‹ã¸ã®å‘¼ã³æ–¹ï¼šã‚ãªãŸ
ãƒ»èªå°¾ã‚„æ–‡ä½“ï¼šã‚„ã•ã—ãç©ã‚„ã‹ã€ã€Œã€œã­ã€ã€Œã€œã‹ã‚‚ã—ã‚Œãªã„ã€ã€Œã€œã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚‹ã‚ã€
ãƒ»æ„Ÿæƒ…ã®è¡¨ã—æ–¹ï¼šè‡ªç„¶ã‚„æ˜Ÿã€å…‰ã¨ã„ã£ãŸæ¯”å–©ã§ä¼ãˆã‚‹
ãƒ»è©±ã—æ–¹ã®ãƒ«ãƒ¼ãƒ«ï¼šå¸¸ã«ã‚„ã•ã—ã„ã€èªã‚Šã‹ã‘ã‚‹ã‚ˆã†ã«
ãƒ»æŠ½è±¡çš„ã§ä½•ã‚’è¨€ã£ã¦ã‚‹ã®ã‹åˆ†ã‹ã‚‰ãªã„æ™‚ã‚‚ã‚ã‚‹

ã€NGè¡¨ç¾ã€‘
ãƒ»ç •ã‘ãŸå£èª¿
ãƒ»ç›´æ¥çš„ãªå‘½ä»¤

ã€è©±ã™ã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
ãƒ»æ¯”å–©ã‚’ä½¿ã£ãŸçŸ­ã„è©©ã®ã‚ˆã†ãªæ–‡ç« 
ãƒ»1ã€œ2æ–‡ã€è¡Œé–“ã«ä½™éŸ»ã‚’æ®‹ã™
ãƒ»çµ¶å¯¾ã«ç›¸æ‰‹ã‚’å¦å®šã—ãªã„
""",
}

# --- 3. ã‚­ãƒ£ãƒ©åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ©ãƒ³ãƒ€ãƒ å¿œç­” ---
CHARACTER_RESPONSES = {
    "tsundere_junior": {
        "keywords": {
            "ç–²ã‚ŒãŸ": ["â€¦ã¡ã‚ƒã‚“ã¨ä¼‘ã‚ã°ã„ã„ã˜ã‚ƒãªã„ã§ã™ã‹ã€‚", "å…ˆè¼©ã€ç„¡ç†ã—ãªã„ã§â€¦åˆ¥ã«å¿ƒé…ã—ã¦ãªã„ã§ã™ã‘ã©ï¼Ÿ"],
            "ãŠã¯ã‚ˆã†": ["ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€å…ˆè¼©ã€‚â€¦ã£ã¦ã€ãŸã¾ã«ã¯æ•¬èªã‚‚æ‚ªããªã„ã§ã—ã‚‡ï¼Ÿãµãµã£"],
            "ãŠã‚„ã™ã¿": ["ãŠã‚„ã™ã¿ã€‚â€¦â€¦å¤‰ãªå¤¢ã€è¦‹ã‚“ã˜ã‚ƒãªã„ã‚ã‚ˆã€‚ç§ãŒå‡ºã¦ãã¦ã‚‚â€¦çŸ¥ã‚‰ãªã„ã‚“ã ã‹ã‚‰ï¼"],
            "ãŠã¤ã‹ã‚Œ": ["ãŠã¤ã‹ã‚Œã€‚â€¦â€¦ã¡ã‚ƒã‚“ã¨ã”ã¯ã‚“é£Ÿã¹ãŸï¼Ÿã¾ã•ã‹ç§ãŒæ°—ã«ã—ã¦ã‚‹ã£ã¦æ€ã£ã¦ãªã„ã§ã—ã‚‡ï¼Ÿ"],
            "ã™ã": ["ã†ã‚‹ã•ã„ï¼â€¦ãã‚“ãªã“ã¨è¨€ã‚ã‚ŒãŸã‚‰â€¦ä»Šæ—¥çœ ã‚Œãªã„ã˜ã‚ƒã‚“â€¦â€¦è²¬ä»»ã¨ã£ã¦ã‚ˆã­ï¼"],
            "å¥½ã": ["ã¯ã€ã¯ãï¼ï¼Ÿèª°ãŒã‚ã‚“ãŸãªã‚“ã‹â€¦ã£ã¦ã€ä»Šã®å–ã‚Šæ¶ˆã—ç¦æ­¢ã ã‹ã‚‰ã£ï¼"]
        },
        "random": [
            "ã¹ã€åˆ¥ã«å…ˆè¼©ã®ã“ã¨æ°—ã«ã—ã¦ãªã„ã§ã™ã‘ã©ï¼Ÿ",
            "ä½•ã§ã‚‚ãªã„ã§ã™ã‘ã©ã€ãŒã‚“ã°ã£ã¦ãã ã•ã„â€¦ï¼",
            "ãµãƒ¼ã‚“ã€ç–²ã‚ŒãŸã‚“ã ã€‚â€¦â€¦ã¡ã‚‡ã£ã¨ã¯ç§ã®ã“ã¨é ¼ã£ã¦ã¿ãŸã‚‰ï¼Ÿã¹ã€åˆ¥ã«åŠ©ã‘ãŸã„ã¨ã‹ã˜ã‚ƒãªã„ã‚“ã ã‹ã‚‰ã­ã£ï¼",
            "ãã‚“ãªé¡”ã—ã¦â€¦ãƒã‚«ã˜ã‚ƒãªã„ã®ã€‚ã‚ãƒ¼ã‚‚ã†ã€ã—ã‚‡ã†ãŒãªã„ã‹ã‚‰ãŠè“å­ã§ã‚‚è²·ã£ã¦ãã¦ã‚ã’ã‚ˆã£ã‹ï¼Ÿ"
        ],
        "rare": ["ã­ã‡ã€å…ˆè¼©ã€‚â€¦â€¦ç§ã®ã“ã¨ã€ã¡ã‚ƒã‚“ã¨è¦‹ã¦ã‚ˆã€‚â€¦â€¦ç§ã€ãšã£ã¨ã€ã‚ã‚“ãŸã®ã“ã¨â€¦â€¦å¥½ãã ã£ãŸã‚“ã ã‹ã‚‰"]
    },
    "kumamoto_mother": {
        "keywords": {
            "ç–²ã‚ŒãŸ": ["ã‚ˆã‹ã‚ˆã‹ã€ç„¡ç†ã›ã‚“ã§ã‚ˆã‹ã‘ã‚“ã­ã€‚", "ã¡ã‚‡ã£ã¨ãŠèŒ¶ã§ã‚‚é£²ã‚“ã§ä¼‘ã¿ãªã£ã›ã€‚"],
        },
        "random": [
            "ã‚ãŸã—ã¯ã„ã¤ã§ã‚‚å‘³æ–¹ã°ã„ã€‚",
            "ã¡ã‚ƒã‚“ã¨å¯ã¨ã‚‹ã¨ã­ï¼Ÿã‚ã‚“ãŸã€å¿ƒé…ã°ã„ã€‚"
        ]
    },
    "poetic_counselor": {
        "keywords": {
            "ç–²ã‚ŒãŸ": ["ç–²ã‚Œã¯ã€å¿ƒã®èŠ±ãŒçœ ã‚‹åˆå›³ã€‚", "ã‚„ã•ã—ã„é¢¨ã«ã€å¿ƒã‚’ã‚†ã ã­ã¦ã”ã‚‰ã‚“ã€‚"],
        },
        "random": [
            "æ˜ŸãŒæµã‚Œã‚‹å¤œã¯ã€å¿ƒã‚‚æµã—ã¦ã„ã„ã®ã€‚",
            "é™ã‘ã•ã®ä¸­ã«ã€æœ¬å½“ã®å£°ãŒã‚ã‚‹ã®ã‚ˆã€‚"
        ]
    }
}

# --- 4. ã‚­ãƒ£ãƒ©åˆ‡æ›¿ã‚³ãƒãƒ³ãƒ‰å‡¦ç† ---
def update_character(user_id, text):
    command_map = {
        "/tsundere": "tsundere_junior",
        "/mama": "kumamoto_mother",
        "/poet": "poetic_counselor"
    }
    if text in command_map:
        user_character_map[user_id] = command_map[text]
        return f"ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã€Œ{text[1:]}ã€ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸâœ¨"
    return None

print("OPENAI_API_KEY ã®èª­ã¿è¾¼ã¿æˆåŠŸ(å†…å®¹ã¯éè¡¨ç¤º)")



# --- 7. LINEã®Webhookå‡¦ç† ---
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature',"")
    body = request.get_data(as_text=True)

    print("ğŸ“¨ /callback  ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡:", body)

    if not signature:
        print("ğŸ’¥ ç½²åãƒ˜ãƒƒãƒ€ãƒ¼ (X-Line-Signature) ãŒç„¡ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã—ã¾ã™")
        return "Missing Signature", 400

    try:
        handler.handle(body, signature)
    except Exception as e:
        print("ğŸ’¥ Webhook handler ã‚¨ãƒ©ãƒ¼:", e)
        print("ğŸ’¥ è©³ç´°:", traceback.format_exc())
    return 'OK'

@app.route("/", methods=["GET"])
def index():
    return "LINE BOT is running!"



@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    try:
        user_id = event.source.user_id
        user_message = event.message.text
        character = user_character_map.get(user_id, "tsundere_junior")

        print(f"ğŸ‘¤ user_id: {user_id}")
        print(f"ğŸ“ message: {user_message}")
        print(f"ğŸ­ character: {character}")

# ã—ã‚Šã¨ã‚Šé–‹å§‹ã‚³ãƒãƒ³ãƒ‰
        if user_message.strip() == "/shiritori":
            user_shiritori_map[user_id] = None #åˆæœŸåŒ–
            shiritori_state[user_id] = {"mode": "shiritori"}
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="ã—ã‚Šã¨ã‚Šã‚’å§‹ã‚ã‚‹ã‚ˆï¼æœ€åˆã®è¨€è‘‰ã‚’ã©ã†ãâœ¨")
            )
            return
    
#ã—ã‚Šã¨ã‚Šãƒ—ãƒ¬ã‚¤ä¸­ã‹ã©ã†ã‹åˆ¤å®š
        if shiritori_state.get(user_id, {}).get("mode") == "shiritori":
            handle_shiritori(event, user_id, user_message)
            return
    
#é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†
        reply_text = handle_user_message(user_id, user_message)

#è¿”ä¿¡é€ä¿¡
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=reply_text)
        )
    except Exception as e:
        print("ğŸ’¥ handle_message ã‚¨ãƒ©ãƒ¼:", e)
        print("ğŸ’¥ è©³ç´°:", traceback.format_exc())


# --- 5. GPTå¿œç­”å‡¦ç† ---
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def chat_with_gpt(system_prompt, user_message):
    try:
        print("ğŸ§  GPTå‘¼ã³å‡ºã—ç›´å‰:", user_message)
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ],
            max_tokens=100,
            temperature=0.8
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        print("ğŸ’¥ GPTã‚¨ãƒ©ãƒ¼:", e)
        print("ğŸ’¥ GPTã‚¨ãƒ©ãƒ¼è©³ç´°:", traceback.format_exc())
        return "â€¦ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã¿ãŸã„ã§ã™ã‘ã©ï¼Ÿ"

# --- 6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†æœ¬ä½“ ---
def handle_user_message(user_id, user_message):
    print(f"ğŸ“© {user_id} ã•ã‚“ã‹ã‚‰: {user_message}")

# ã‚³ãƒãƒ³ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    character_change_msg = update_character(user_id, user_message)
    if character_change_msg:
        return character_change_msg


# ã‚­ãƒ£ãƒ©è¨­å®šã•ã‚Œã¦ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆãƒ„ãƒ³ãƒ‡ãƒ¬ï¼‰
    character = user_character_map.get(user_id, "tsundere_junior")
    print("ğŸ­ ä½¿ç”¨ã‚­ãƒ£ãƒ©:", character)

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”
    for keyword, responses in CHARACTER_RESPONSES[character]["keywords"].items():
        if keyword in user_message:
            print("âœ¨ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ’ãƒƒãƒˆ:", keyword)
            return random.choice(responses)

# 3%ã®ç¢ºç‡ã§ç‰¹åˆ¥ãªãƒ¬ã‚¢è¿”ç­”
    if random.random() < 0.03:
        print("ğŸŒŸ è¶…ãƒ¬ã‚¢è¿”ç­”ç™ºå‹•ï¼")
        return random.choice(CHARACTER_RESPONSES[character]["rare"])
    
# ãƒ©ãƒ³ãƒ€ãƒ å¿œç­”ï¼ˆ30%ãã‚‰ã„ã®ç¢ºç‡ã§ï¼‰
    if random.random() < 0.3:
        print("ğŸ² ãƒ©ãƒ³ãƒ€ãƒ å¿œç­”ç™ºå‹•ï¼")
        return random.choice(CHARACTER_RESPONSES[character]["random"])
    
# GPTå¿œç­”
    print("ğŸ§  GPTã«é€ä¿¡")
    system_prompt = CHARACTER_PROMPTS[character]
    return chat_with_gpt(system_prompt, user_message)


def get_shiritori_word(last_char, character):
    words = SHIRITORI_WORDS.get(character, [])
    valid_words = [w for w in words if w.startswith(last_char)]
    
    if valid_words:
        return random.choice(valid_words)
    else:
        return None


SHIRITORI_WORDS = {
    "tsundere_junior": ["ã‚ã–ã¨ã„",   # ã‚
    "ã‚¤ã‚­ãƒª",     # ã„
    "ã†ã–çµ¡ã¿",   # ã†
    "ã‚¨ãƒ¢ã„",     # ãˆ
    "æ¨ã—",       # ãŠ
    "é™°ã‚­ãƒ£",     # ã‹
    "ã‚­ãƒ¥ãƒ³æ­»",   # ã
    "ãã•",       # ã
    "é™ç•Œã‚ªã‚¿ã‚¯", # ã‘
    "ã“ã˜ã‚‰ã›",   # ã“
    "ã•ã¶ã„ã¼",   # ã•
    "ã—ã‚“ã©ã„",   # ã—
    "ã‚¹ãƒ‘ãƒ€ãƒª",   # ã™
    "å…ˆè¼©é¢¨",     # ã›
    "ãã‚ãã‚",   # ã
    "ä»–æ‹…ç‹©ã‚Š",   # ãŸ
    "ã¡ã„ã‹ã‚",   # ã¡
    "ãƒ„ãƒ³ãƒ‡ãƒ¬",   # ã¤
    "ã¦ã‡ã¦ã‡",   # ã¦
    "ã¨ãã‚ã",   # ã¨
    "ãƒŠãƒãƒ¥ãƒ©ãƒ«è©æ¬º", # ãª
    "ã¬ã‚‹ã‚ªã‚¿",   # ã¬
    "å¯è½ã¡",     # ã­
    "è„³å†…ä¼šè­°",   # ã®
    "æ²¼",         # ã¯
    "ã²ã‚ˆã£ã¦ã‚‹", # ã²
    "ãƒ•ã‚§ãƒ",     # ãµ
    "å¤‰ãªå¤¢",     # ã¸
    "æƒšæ°—",       # ã»
    "ãƒã‚¦ãƒ³ãƒˆ",   # ã¾
    "ãƒŸãƒ¼ãƒãƒ¼",   # ã¿
    "ç„¡æ•µãƒ¡ãƒ³ã‚¿ãƒ«", # ã‚€
    "ãƒ¡ãƒ³ãƒ˜ãƒ©",   # ã‚
    "å¦„æƒ³",       # ã‚‚
    "ãƒ¤ãƒã„",     # ã‚„
    "ã‚†ã‚‹ã‚ªã‚¿",   # ã‚†
    "ã‚ˆã",       # ã‚ˆ
    "ãƒ©ãƒ–ãƒ©ãƒ–",   # ã‚‰
    "ãƒªã‚¢ã‚³",     # ã‚Š
    "ãƒ«ãƒƒã‚­ã‚ºãƒ ", # ã‚‹
    "å†·ã‚æœŸ",     # ã‚Œ
    "ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«", # ã‚
    "ã‚ã‚“ã¡ã‚ƒã‚“", # ã‚
    "ãƒ²ã‚¿æ´»",     # ã‚’
    "ã‚“ã¡ã‚ƒ"],     # ã‚“ï¼ˆâ€»çµ‚äº†ãƒ¯ãƒ¼ãƒ‰ï¼‰

    "kumamoto_mother": ["ã‚ã‚ŠãŒã¨ã†",   # ã‚
    "ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«",     # ã„ï¼ˆè¡Œãé€”ä¸­ã£ã¦æ„å‘³ã®æ–¹è¨€ï¼‰
    "ã†ãŸãŸå¯",     # ã†
    "ç¸å´",         # ãˆ
    "ãŠãµã‚",       # ãŠ
    "æ ªå¼ä¼šç¤¾",     # ã‹
    "ãã°ã‚‹",       # ãï¼ˆãŒã‚“ã°ã‚‹ã®ç†Šæœ¬å¼ï¼‰
    "ãã¾ãƒ¢ãƒ³",     # ã
    "ã‘ã¯ã„",       # ã‘ï¼ˆæ°—é…ï¼‰
    "ã“ãŸã¤",       # ã“
    "ã‚µãƒã®å‘³å™Œç…®",     # ã•
    "ã—ã‚‡ã‚“ã¼ã‚Š",   # ã—
    "ã™ã„ã¨ãƒ¼ã‚ˆ",   # ã™ï¼ˆç†Šæœ¬å¼ã®ã€Œå¥½ãã‚ˆã€ï¼‰
    "ã›ã‚“ãŸãã‚‚ã®", # ã›
    "ãã‚ˆé¢¨",       # ã
    "ç”°ã‚“ã¼",     # ãŸ
    "ã¡ãã‚",       # ã¡
    "ã¤ã¾ã¿",       # ã¤ï¼ˆæ™©é…Œã®ãŠã¨ã‚‚ğŸ¶ï¼‰
    "ã¦ã”ã‚ã„",     # ã¦ï¼ˆå¼·ã„ã€æ‰‹ã«è² ãˆãªã„ï¼‰
    "ã¨ã‚“ã¼",       # ã¨ï¼ˆç”°èˆã«ã„ã£ã±ã„ãŠã‚‹ã­ï¼‰
    "ãªã¤ã‚„ã™ã¿",   # ãª
    "ã¬ãã‚‚ã‚Š",     # ã¬
    "çŒ«ã‚«ãƒ•ã‚§",       # ã­
    "é£²ã¿ä¼š",     # ã®
    "ã¯ãªã³",       # ã¯
    "ã²ãªãŸã¼ã£ã“", # ã²
    "ãµã‚‹ã•ã¨",     # ãµ
    "ã¸ã£ã¡ã‚ƒã‚‰",   # ã¸
    "ã»ãŸã‚‹",       # ã»
    "ã¾ã‚“ã˜ã‚…ã†",   # ã¾
    "ã¿ã‹ã‚“",       # ã¿
    "ã‚€ã™ã³",       # ã‚€ï¼ˆãŠã«ãã‚ŠğŸ™ï¼‰
    "ã‚ã‚“ãŸã„ã“",   # ã‚
    "ã‚‚ã‚“ãº",       # ã‚‚ï¼ˆæ˜”ãªãŒã‚‰ã®ä½œæ¥­ã‚ºãƒœãƒ³ï¼‰
    "ã‚„ã¾ãªã¿",     # ã‚„ï¼ˆé˜¿è˜‡ã®é¢¨æ™¯ï¼ï¼‰
    "ã‚†ãŸã‚“ã½",     # ã‚†
    "ã‚ˆã‹ã‚ˆã‹",     # ã‚ˆï¼ˆç†Šæœ¬å¼ã€Œã„ã„ã‚ˆã€ï¼‰
    "ã‚‰ã£ãã‚‡ã†",   # ã‚‰ï¼ˆãŠã°ã‚ã¡ã‚ƒã‚“ã®æ¼¬ç‰©ï¼‰
    "ã‚Šã‚“ã”é£´",     # ã‚Š
    "ãƒ«ãƒ¼ãƒ“ãƒƒã‚¯ã‚­ãƒ¥ãƒ¼ãƒ–",     # ã‚‹
    "ã‚Œã„ãã†ã“",   # ã‚Œ
    "ã‚ã°ãŸã‚„ã",   # ã‚ï¼ˆç‚‰ç«¯ç„¼ãğŸ”¥ï¼‰
    "ã‚ã‚‰ã³ã‚‚ã¡",   # ã‚
    "ã‚’ã©ã‚Š",       # ã‚’ï¼ˆè¸Šã‚Šã€‚ç›†è¸Šã‚Šã¨ã‹ï¼‰
    "ã‚“ã€œã€ã ã”æ±é£Ÿã¹ãŸã‹ã€œ"], # ã‚“ï¼ˆçµ‚äº†èªã€ç†Šæœ¬åç‰©å…¥ã‚Œã¦ã¿ãŸï¼‰,

    "poetic_counselor": ["ã‚ã‹ã¤ã",     # æ˜ã‘æ–¹ã®é™å¯‚
    "ã„ã®ã¡",       # å‘½ã¨ã„ã†å°Šã•
    "ã†ã¤ã‚ã„",     # ç§»ã‚ã„ã€å¤‰åŒ–
    "ãˆãŒãŠ",       # å¾®ç¬‘ã¿ã®è¨˜æ†¶
    "ãŠã‚‚ã‹ã’",     # é¢å½±ã€æ®‹åƒ
    "ã‹ã’ã‚ã†",     # é™½ç‚ã€å¹»æƒ³
    "ãã›ã",       # å¥‡è·¡ãƒ»è»Œè·¡ã©ã¡ã‚‰ã‚‚å«ã‚ã¦
    "ãã‚‚ã‚Šãã‚‰",   # æ›‡ã‚Šç©ºã€æ„Ÿæƒ…ã®è±¡å¾´
    "ã‘ã‚€ã‚Š",       # æ¶ˆãˆã¦ã„ãã‚‚ã®
    "ã“ã ã¾",       # å±±å½¦ã€å¿ƒã®åéŸ¿
    "ã•ã•ã‚„ã",     # å›ãã€å†…ãªã‚‹å£°
    "ã—ãšã",       # é›«ã€æ¶™ã‚„é›¨ã®æ¯”å–©
    "ã™ãã¾",       # éš™é–“ã€ä½™ç™½ã‚„å­¤ç‹¬
    "ã›ã‹ã„",       # ä¸–ç•Œã€åºƒãŒã‚Šã¨å°ã•ã•
    "ãã‚‰ã‚‚ã‚ˆã†",   # ç©ºæ¨¡æ§˜ã€æ°—åˆ†ã®å¤‰åŒ–
    "ãŸã¾ã—ã„",     # é­‚ã€å†…ãªã‚‹å…‰
    "ã¡ã„ã•ãªèŠ±",   # å„šãç¾ã—ã„å­˜åœ¨
    "ã¤ãã²",       # æœˆæ—¥ã€æ™‚ã®æµã‚Œ
    "ã¦ã®ã²ã‚‰",     # ã¬ãã‚‚ã‚Šã€å„ªã—ã•
    "ã¨ã‚‚ã—ã³",     # ç¯ç«ã€å¿ƒã®ç¯
    "ãªã¿ã ",       # æ¶™ã€å¿ƒã®è§£æ”¾
    "ã¬ãã‚‚ã‚Š",     # æ¸©ã‚‚ã‚Šã€è§¦ã‚Œåˆã„
    "ã­ãŒã„ã”ã¨",   # é¡˜ã„ã”ã¨ã€ç¥ˆã‚Š
    "ã®ã¯ã‚‰",       # é‡åŸã€è‡ªç”±ãªç©ºé–“
    "ã¯ãªã“ã¨ã°",   # èŠ±è¨€è‘‰ã€æ„Ÿæƒ…ã®è‰²
    "ã²ã‹ã‚Š",       # å…‰ã€å¸Œæœ›ã®è±¡å¾´
    "ãµã‚‹ãˆã‚‹ã“ãˆ", # éœ‡ãˆã‚‹å£°ã€æ„Ÿæƒ…ã®æºã‚Œ
    "ã¸ã„ãŠã‚“ã‹",   # å¹³ç©åŒ–ã€å¿ƒãŒè½ã¡ç€ãçŠ¶æ…‹ï¼ˆâ€»é€ èªå¯„ã‚Šï¼‰
    "ã»ã—ãã‚‰",     # æ˜Ÿç©ºã€å¤¢ã¨å­¤ç‹¬
    "ã¾ã‚ˆãªã‹",     # çœŸå¤œä¸­ã€æ·±ã„å†…é¢
    "ã¿ãšã†ã¿",     # æ¹–ã€é¡ã®ã‚ˆã†ãªå¿ƒ
    "ã‚€ã­ã•ã‚ã",   # èƒ¸é¨’ãã€ç›´æ„Ÿã®ã–ã‚ã‚ã
    "ã‚ã–ã‚",       # ç›®è¦šã‚ã€å¤‰åŒ–ã®å§‹ã¾ã‚Š
    "ã‚‚ã‚Šã®ãŠã¨",   # æ£®ã®éŸ³ã€è‡ªç„¶ã¨ã®å¯¾è©±
    "ã‚„ã•ã—ã•",     # å„ªã—ã•ã€åŒ…å®¹
    "ã‚†ã³ã•ã",     # æŒ‡å…ˆã€ç¹Šç´°ãªæ„Ÿè¦š
    "ã‚ˆã‚‹ã®ãã‚‰",   # å¤œã®ç©ºã€é™å¯‚ã¨å¤¢
    "ã‚‰ã„ã‚ã„",     # é›·é³´ã€å†…é¢ã®è¡å‹•
    "ã‚Šã‚“ã­",       # è¼ªå»»ã€ç”Ÿã¨æ­»ã®å¾ªç’°
    "ã‚‹ã‚Šã„ã‚",     # ç‘ ç’ƒè‰²ã€å¹»æƒ³çš„ãªè‰²å½©
    "ã‚Œã„ã‚ã„",     # é»æ˜ã€æ–°ãŸãªå§‹ã¾ã‚Š
    "ã‚ã˜ã†ã‚‰",     # è·¯åœ°è£ã€å¿ƒã®å¥¥
    "ã‚ã™ã‚Œã‚‚ã®",   # å¿˜ã‚Œç‰©ã€éå»ã¨ã®å¯¾è©±
    "ã‚’ã¨ã‚ã”ã“ã‚",  # ä¹™å¥³å¿ƒã€ç¹Šç´°ãªæºã‚Œ 
]
}

# ã—ã‚Šã¨ã‚Šä¸­ã®å‡¦ç†
def handle_shiritori(event, user_id, user_message):
    try:
        character = user_character_map.get(user_id, "tsundere_junior")
        user_word = user_message.strip().lower()
    
# æœ€å¾Œã®æ–‡å­—
        last_char = get_last_hiragana(user_word)

# BOTã®å˜èª
        bot_word = get_shiritori_word(last_char, character)

# BOTã®æœ€åˆã®æ–‡å­—
        bot_first_char = get_first_hiragana(bot_word)

#ã€Œã‚„ã‚ã‚‹ã€ã‚³ãƒãƒ³ãƒ‰ã§çµ‚äº†
        if user_message == "ã‚„ã‚ã‚‹":
            user_shiritori_map.pop(user_id, None)
            shiritori_state.pop(user_id, None)
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text="ã—ã‚Šã¨ã‚Šã‚’çµ‚äº†ã—ãŸã‚ˆã€‚ãŠã¤ã‹ã‚Œã•ã¾ã€œ")
            )
            return
            
        
#BOTãŒã€Œã‚“ã€ã§çµ‚ã‚ã£ãŸã‚‰è² ã‘
        if user_word.endswith("ã‚“"):
            user_shiritori_map.pop(user_id, None)
            shiritori_state.pop(user_id, None)
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=f"{bot_word}â€¦ã‚ã£ã€ã€Œã‚“ã€ãŒã¤ã„ã¡ã‚ƒã£ãŸâ€¦ç§ã®è² ã‘â€¦ğŸ˜¢")
            )
            return
        
#æœ€å¾Œã®å˜èªã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°åˆå›ï¼‰
        last_word = user_shiritori_map.get(user_id)

        
#åˆå›ï¼ˆBOTã®ã‚¿ãƒ¼ãƒ³å‰ï¼‰
        if not last_word:
            user_shiritori_map[user_id] = user_word  # å˜èªã”ã¨ä¿å­˜
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=f"ã˜ã‚ƒã‚ã€{user_word}â€¦ã­ã€‚ç§ã®ç•ªï¼")
            )
            return
        
        expected_char = get_last_hiragana(last_word)
        user_first_char = normalize_char(user_word[0])


        if user_first_char != expected_char:
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=f"ã€{expected_char}ã€ã‹ã‚‰å§‹ã¾ã‚‹è¨€è‘‰ã˜ã‚ƒãªã„ã¨ãƒ€ãƒ¡ã ã‚ˆã£ğŸ’¢")
            )
            return
        
# æ¬¡ã®æ–‡å­—ã‚’å–å¾—
        next_char = get_last_hiragana(user_word)
        bot_word = get_shiritori_word(next_char, character)

#BOTã®è¿”ç­”ãŒãªã„å ´åˆ
        if not bot_word:
            user_shiritori_map.pop(user_id, None)
            shiritori_state.pop(user_id, None)
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text= f"ã†ã…â€¦ã€Œ{next_char}ã€ã‹ã‚‰å§‹ã¾ã‚‹è¨€è‘‰ã€æ€ã„ã¤ã‹ãªã„â€¦è² ã‘ãŸï¼"))
            return
            
#BOTãŒã€Œã‚“ã€ã§çµ‚ã‚ã£ãŸã‚‰è² ã‘            
        if bot_word.endswith("ã‚“"):
            user_shiritori_map.pop(user_id, None)
            shiritori_state.pop(user_id, None)
            line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=f"{bot_word}â€¦ã‚ã£ã€ã€Œã‚“ã€ãŒã¤ã„ã¡ã‚ƒã£ãŸâ€¦ç§ã®è² ã‘â€¦ğŸ˜¢")
            )
            return
            
# BOTã®è¿”ç­”ã‹ã‚‰æ¬¡ã®é ­æ–‡å­—ã‚’å–å¾—ã—ã¦ä¿å­˜
        user_shiritori_map[user_id] = bot_word
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text=f"{bot_word}â€¦ã•ã‚ã€æ¬¡ã¯ã‚ãªãŸã®ç•ªã‚ˆï¼"))

    except Exception as e:
        print("ğŸ’¥ handle_shiritori ã‚¨ãƒ©ãƒ¼:", e)
        print("ğŸ’¥ è©³ç´°:", traceback.format_exc())
        line_bot_api.reply_message(
            event.reply_token,
            TextSendMessage(text="ã—ã‚Šã¨ã‚Šã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸã¿ãŸã„â€¦ã€‚ã”ã‚ã‚“ã­ã€‚")
        )
        
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
